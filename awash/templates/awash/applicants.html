{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-5">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">All Jobs</h3>

    <div class="d-flex">
      <div class="me-3 d-flex align-items-center">
        <label for="pageSize" class="me-2 mb-0">Rows:</label>
        <select id="pageSize" class="form-select form-select-sm">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>

      <div class="d-flex align-items-center">
        <label for="searchInput" class="me-2 mb-0">Search:</label>
        <input id="searchInput" class="form-control form-control-sm" type="search" placeholder="Vacancy No, Title, Status">
      </div>
    </div>
  </div>

  <div class="table-responsive shadow-sm rounded">
    <table id="jobsTable" class="table table-hover table-bordered mb-0">
      <thead class="table-dark">
        <tr>
          <!-- data-key used by JS, data-type tells comparator -->
          <th data-key="vacancy" data-type="string" style="cursor:pointer">
            Vacancy No
            <span class="sort-indicator ms-1"></span>
          </th>
          <th data-key="title" data-type="string" style="cursor:pointer">
            Job Title
            <span class="sort-indicator ms-1"></span>
          </th>
          <th data-key="posted" data-type="date" style="cursor:pointer">
            Posted Date
            <span class="sort-indicator ms-1"></span>
          </th>
          <th data-key="deadline" data-type="date" style="cursor:pointer">
            Deadline
            <span class="sort-indicator ms-1"></span>
          </th>
          <th data-key="status" data-type="string" style="cursor:pointer">
            Status
            <span class="sort-indicator ms-1"></span>
          </th>
          <th data-key="apps" data-type="number" style="cursor:pointer">
            Applicants
            <span class="sort-indicator ms-1"></span>
          </th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for job in jobs %}
        <tr data-job-id="{{ job.id }}"
            data-vacancy="{{ job.vacancy_number|default:'' }}"
            data-title="{{ job.title|default:''|escapejs }}"
            data-posted="{{ job.posted_date|date:'Y-m-d H:i:s' }}"
            data-deadline="{{ job.deadline|date:'Y-m-d' }}"
            data-status="{% if job.is_active %}Active{% else %}Closed{% endif %}"
            data-apps="{{ job.applications.count }}">
          <td>{{ job.vacancy_number }}</td>
          <td>{{ job.title }}</td>
          <td>{{ job.posted_date|date:"M d, Y H:i" }}</td>
          <td>{{ job.deadline|date:"M d, Y" }}</td>
          <td>
            {% if job.is_active %}
              <span class="badge bg-success">Active</span>
            {% else %}
              <span class="badge bg-secondary">Closed</span>
            {% endif %}
          </td>
          <td>{{ job.applications.count }}</td>
          <td>
            <a href="{% url 'view_applicants_per_job' job.id  %} " class="btn btn-sm btn-primary">View Applicants</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted py-4">No jobs found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- no-results message -->
  <div id="noResults" class="alert alert-info text-center mt-3 d-none">
    No matching jobs found.
  </div>

  <!-- Pagination -->
  <nav class="mt-3">
    <ul id="pagination" class="pagination justify-content-center"></ul>
    <div id="pageSummary" class="text-center small text-muted mt-2"></div>
  </nav>
</div>

<style>
  /* small visual helpers */
  th[data-key] { user-select: none; }
  .sort-indicator { font-size: 0.8rem; color: #ddd; }
  th.sorted-asc .sort-indicator::after { content: " ▲"; color: #fff; }
  th.sorted-desc .sort-indicator::after { content: " ▼"; color: #fff; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Elements
  const tbody = document.querySelector('#jobsTable tbody');
  const allRows = Array.from(tbody.querySelectorAll('tr[data-job-id]'));
  const searchInput = document.getElementById('searchInput');
  const pageSizeSelect = document.getElementById('pageSize');
  const paginationEl = document.getElementById('pagination');
  const noResultsEl = document.getElementById('noResults');
  const pageSummary = document.getElementById('pageSummary');
  const headers = Array.from(document.querySelectorAll('#jobsTable thead th[data-key]'));

  // State
  let filtered = allRows.slice();
  let currentPage = 1;
  let rowsPerPage = parseInt(pageSizeSelect.value, 10);
  let sortKey = null;
  let sortDir = 1; // 1 = asc, -1 = desc

  // Helpers to get data from row
  const getValue = (row, key) => row.dataset[key] ?? '';

  // Type-aware comparator
  function compareRows(a, b, key, type) {
    const av = getValue(a, key);
    const bv = getValue(b, key);

    if (type === 'number') {
      const an = parseInt(av || '0', 10);
      const bn = parseInt(bv || '0', 10);
      return an - bn;
    }
    if (type === 'date') {
      const ad = new Date(av || '');
      const bd = new Date(bv || '');
      return ad - bd;
    }
    // fallback string (case-insensitive)
    return av.toLowerCase().localeCompare(bv.toLowerCase());
  }

  // Render functions
  function renderPage() {
    // ensure valid page
    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / rowsPerPage));
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;

    // clear table body then append slice
    tbody.innerHTML = '';
    const start = (currentPage - 1) * rowsPerPage;
    const slice = filtered.slice(start, start + rowsPerPage);

    if (slice.length === 0 && total === 0) {
      noResultsEl.classList.remove('d-none');
    } else {
      noResultsEl.classList.add('d-none');
      slice.forEach(r => tbody.appendChild(r));
    }

    renderPagination(totalPages);
    pageSummary.textContent = total === 0
      ? ''
      : `Showing ${Math.min(start+1, total)}–${Math.min(start + slice.length, total)} of ${total} jobs`;
  }

  function renderPagination(totalPages) {
    paginationEl.innerHTML = '';

    const createLi = (label, page, disabled=false, active=false) => {
      const li = document.createElement('li');
      li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
      li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
      li.addEventListener('click', (e) => {
        e.preventDefault();
        if (!disabled && currentPage !== page) {
          currentPage = page;
          renderPage();
        }
      });
      return li;
    };

    // First / Prev
    paginationEl.appendChild(createLi('<<', 1, currentPage === 1));
    paginationEl.appendChild(createLi('‹', Math.max(1, currentPage-1), currentPage === 1));

    // page numbers (show window)
    const maxButtons = 7;
    let start = Math.max(1, currentPage - Math.floor(maxButtons/2));
    let end = start + maxButtons - 1;
    if (end > totalPages) { end = totalPages; start = Math.max(1, end - maxButtons + 1); }

    for (let p = start; p <= end; p++) {
      paginationEl.appendChild(createLi(p, p, false, p === currentPage));
    }

    // Next / Last
    paginationEl.appendChild(createLi('›', Math.min(totalPages, currentPage+1), currentPage === totalPages));
    paginationEl.appendChild(createLi('>>', totalPages, currentPage === totalPages));
  }

  // Filtering
  function applyFilter() {
    const q = (searchInput.value || '').trim().toLowerCase();
    if (!q) {
      filtered = allRows.slice();
    } else {
      filtered = allRows.filter(row => {
        const vacancy = (row.dataset.vacancy || '').toLowerCase();
        const title = (row.dataset.title || '').toLowerCase();
        const status = (row.dataset.status || '').toLowerCase();
        // include apps (number) as well (string)
        const apps = (row.dataset.apps || '').toLowerCase();
        return vacancy.includes(q) || title.includes(q) || status.includes(q) || apps.includes(q);
      });
    }
    // after filtering, apply sorting if any
    if (sortKey) applySort(sortKey, false);
    currentPage = 1;
    renderPage();
  }

  // Sorting
  function applySort(key, toggle = true) {
    // find type from header
    const th = headers.find(h => h.dataset.key === key);
    const type = th ? th.dataset.type : 'string';
    if (toggle) {
      if (sortKey === key) sortDir = -sortDir;
      else { sortKey = key; sortDir = 1; }
    } else {
      // if invoked programmatically (e.g. after filter), keep current sortDir
      sortKey = key;
    }

    // remove sorted classes
    headers.forEach(h => h.classList.remove('sorted-asc','sorted-desc'));
    const activeTh = headers.find(h => h.dataset.key === sortKey);
    if (activeTh) activeTh.classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');

    filtered.sort((a,b) => sortDir * compareRows(a,b, sortKey, type));
    currentPage = 1;
    renderPage();
  }

  // Attach header click listeners
  headers.forEach(h => {
    const key = h.dataset.key;
    h.addEventListener('click', () => applySort(key, true));
  });

  // Events
  searchInput.addEventListener('input', () => {
    applyFilter();
  });

  pageSizeSelect.addEventListener('change', () => {
    rowsPerPage = parseInt(pageSizeSelect.value, 10) || 10;
    currentPage = 1;
    renderPage();
  });

  // initial render
  applyFilter(); // populates filtered and renders
});
</script>
{% endblock %}
