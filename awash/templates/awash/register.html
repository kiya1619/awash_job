{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Registration</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: #f2f6fc;
    }
    .card {
      border-radius: 20px;
    }
    #extra-fields {
      transition: all 0.3s ease-in-out;
    }
    .password-strength {
      height: 5px;
      border-radius: 5px;
      transition: width 0.3s;
    }
  </style>
</head>
<body>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6">

      {% if has_account %}
      <!-- Already has account -->
      <div class="alert alert-info shadow text-center p-4 rounded-4">
        <h4 class="mb-2"><i class="bi bi-person-check"></i> Account Already Exists</h4>
        <p class="mb-0">This employee already has an account. <a href="{% url 'login' %}" class="link-primary">Login here</a></p>
      </div>
      {% else %}
      <!-- Registration Form -->
      <div class="card shadow-lg p-4">
        <h3 class="text-center mb-4">Create Employee Account</h3>

        <form method="POST" id="account-form">
          {% csrf_token %}

          <!-- Employee ID -->
          <div class="mb-3">
            <label for="employee_id" class="form-label">Employee ID</label>
            <input type="text" class="form-control rounded-3" id="employee_id" name="employee_id" placeholder="Enter Employee ID" required>
            <small id="emp-message" class="text-danger mt-1"></small>
          </div>

          <!-- Extra Fields -->
          <div id="extra-fields" style="display:none;">

            <!-- Full Name (read-only) -->
            <div class="mb-3">
              <label for="full_name" class="form-label">Full Name</label>
              <input type="text" class="form-control rounded-3" id="full_name" name="full_name" readonly>
            </div>

            <!-- Email -->
            <div class="mb-3">
              <label for="email" class="form-label">Email Address</label>
              <input type="email" class="form-control rounded-3" id="email" name="email" placeholder="Enter email" required>
            </div>

            <!-- Position -->
            <div class="mb-3">
              <label for="position" class="form-label">Position</label>
              <select class="form-select rounded-3" id="position" name="position" required>
                <option value="">Select position</option>
                {% for pos in positions %}
                  <option value="{{ pos }}">{{ pos }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Password -->
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control rounded-3" id="password" name="password1" placeholder="Enter password" required>
              <div class="mt-1">
                <div class="password-strength bg-danger w-0" id="password-strength"></div>
                <small class="text-muted">Password strength</small>
              </div>
            </div>

            <!-- Confirm Password -->
            <div class="mb-3">
              <label for="password2" class="form-label">Confirm Password</label>
              <input type="password" class="form-control rounded-3" id="password2" name="password2" placeholder="Confirm password" required>
            </div>

            <button type="submit" class="btn btn-primary w-100 rounded-3">Create Account</button>

          </div>
        </form>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const loginUrl = "{% url 'login' %}";
const employeeInput = document.getElementById("employee_id");
const empMessage = document.getElementById("emp-message");
const extraFields = document.getElementById("extra-fields");
const fullNameInput = document.getElementById("full_name");
const emailInput = document.getElementById("email");
const positionSelect = document.getElementById("position");
const passwordInput = document.getElementById("password");
const passwordStrength = document.getElementById("password-strength");

employeeInput.addEventListener("blur", function() {
    const empId = this.value.trim();
    if(!empId) return;

    fetch(`/get-employee/?employee_id=${empId}`)
    .then(res => res.json())
    .then(data => {
        if(data.error === "not_found"){
            empMessage.innerText = "❌ Employee not found. Contact HR.";
            extraFields.style.display = "none";
        } 
        else if(data.error === "already_registered"){
            extraFields.style.display = "none";
            empMessage.innerHTML = `ℹ️ You already have an account. <a href="${loginUrl}" class="link-primary">Login here</a>`;
        }
        else {
            // Employee exists but no account yet
            empMessage.innerText = "";
            extraFields.style.display = "block";

            // Fill values
            fullNameInput.value = data.full_name || "";
            emailInput.value = data.email || "";
            positionSelect.value = data.department || "";
        }
    })
    .catch(err => console.error(err));
});

// Password strength indicator
if(passwordInput){
    passwordInput.addEventListener("input", function() {
        const val = this.value;
        let width = 0, color = "bg-danger";
        if(val.length > 5) width = 40;
        if(val.length > 8) width = 70;
        if(val.length > 12) width = 100;

        if(width >= 70) color = "bg-success";
        else if(width >= 40) color = "bg-warning";
        else color = "bg-danger";

        passwordStrength.style.width = width + "%";
        passwordStrength.className = "password-strength " + color;
    });
}
</script>
</body>
</html>
