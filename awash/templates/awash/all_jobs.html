{% extends "base.html" %}

{% block content %}

{% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      {% if message.tags == "error" %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {% elif message.tags == "warning" %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
      {% elif message.tags == "success" %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
      {% else %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
      {% endif %}
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
  </div>
{% endif %}

<div class="container-fluid mt-5">
    <h2 class="mb-4 text-center">All Job Postings</h2>

    {% if jobs %}
    <div class="d-flex justify-content-between mb-2">
        <!-- Page size selector -->
        <div class="d-flex align-items-center">
            <label for="pageSize" class="me-2">Rows per page:</label>
            <select id="pageSize" class="form-select w-auto">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
            </select>
        </div>

        <!-- Search filter -->
        <div class="d-flex align-items-center">
            <label for="searchInput" class="me-2">Search:</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Search by Vacancy No, Title, Status">
        </div>
    </div>

    <div class="table-responsive">
        <table id="jobsTable" class="table table-striped table-hover align-middle table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Vacancy No</th>
                    <th>Job Title</th>
                    <th>Posted Date</th>
                    <th>Deadline</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for job in jobs %}
                <tr>
                    <td>{{ job.vacancy_number }}</td>
                    <td>{{ job.title }}</td>
                    <td>{{ job.posted_date|date:"M d, Y" }}</td>
                    <td>{{ job.deadline|date:"M d, Y" }}</td>
                    <td>
                        {% if job.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'view_detail' job.id %}" class="btn btn-sm btn-info">View Detail</a>

                        {% if not request.user.is_staff %}
                            {% if job.id in applied_job_ids %}
                                <button class="btn btn-sm btn-secondary" disabled>Applied</button>
                            {% else %}
                                <a href="{% url 'apply' job.id %}" class="btn btn-sm btn-success">Apply</a>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'edit_job' job.id %}" class="btn btn-sm btn-warning">Edit</a>
                            <button type="button" class="btn btn-sm btn-danger" onclick="confirmDelete({{ job.id }});">
                                Delete
                            </button>   
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <nav>
        <ul id="pagination" class="pagination justify-content-center mt-3"></ul>
    </nav>

    {% else %}
        <div class="alert alert-info text-center">
            No jobs available at the moment. Please check back later.
        </div>
    {% endif %}
</div>

<script>
function confirmDelete(jobId) {
    if (confirm("Are you sure you want to delete this job? This action cannot be undone.")) {
        window.location.href = "{% url 'delete_job' 0 %}".replace('0', jobId);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('jobsTable');
    const tbody = table.querySelector('tbody');
    const allRows = Array.from(tbody.querySelectorAll('tr'));
    const pageSizeSelector = document.getElementById('pageSize');
    const searchInput = document.getElementById('searchInput');
    const pagination = document.getElementById('pagination');

    let rowsPerPage = parseInt(pageSizeSelector.value);
    let currentPage = 1;
    let filteredRows = allRows;

    function renderTable() {
        tbody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const rowsToShow = filteredRows.slice(start, end);
        rowsToShow.forEach(row => tbody.appendChild(row));
        renderPagination();
    }

    function renderPagination() {
        pagination.innerHTML = '';
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);

        function createPageItem(label, page, disabled=false, active=false) {
            const li = document.createElement('li');
            li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
            li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
            li.addEventListener('click', function(e) {
                e.preventDefault();
                if (!disabled && currentPage !== page) {
                    currentPage = page;
                    renderTable();
                }
            });
            return li;
        }

        // First & Prev
        pagination.appendChild(createPageItem('<<', 1, currentPage === 1));
        pagination.appendChild(createPageItem('<', currentPage - 1, currentPage === 1));

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            pagination.appendChild(createPageItem(i, i, false, currentPage === i));
        }

        // Next & Last
        pagination.appendChild(createPageItem('>', currentPage + 1, currentPage === totalPages));
        pagination.appendChild(createPageItem('>>', totalPages, currentPage === totalPages));
    }

    pageSizeSelector.addEventListener('change', function() {
        rowsPerPage = parseInt(this.value);
        currentPage = 1;
        renderTable();
    });

    searchInput.addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        filteredRows = allRows.filter(row => {
            const vacancy = row.cells[0].textContent.toLowerCase();
            const title = row.cells[1].textContent.toLowerCase();
            const status = row.cells[4].textContent.toLowerCase();
            return vacancy.includes(filter) || title.includes(filter) || status.includes(filter);
        });
        currentPage = 1;
        renderTable();
    });

    renderTable();
});
</script>

{% endblock %}
